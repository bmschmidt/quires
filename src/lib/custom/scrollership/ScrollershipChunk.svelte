<script lang="ts">
	import Block from '$lib/Block.svelte';
	import type QuireObserver from '$lib/quireObserver.svelte';
	import type { Div } from '@djot/djot';

	let { quire }: { quire: QuireInScroller<Div> } = $props();

	import type { QuireInScroller } from './utils';

	let div: HTMLDivElement;

	let active = $state(false);

	let custom: Record<string, unknown> = $state({ ...quire.custom });

	$effect(() => {
		const observer = quire.custom.observer;
		if (observer === undefined) {
			return;
			throw new Error('observer is undefined');
		}
		// We use this callback only to adjust styles. The
		// API codeblocks will be called from the div layer.

		observer.observe(div, function (entry) {
			if (entry.isIntersecting) {
				active = true;
			} else {
				active = false;
			}
		});
		custom = {
			...quire.custom,
			triggerNode: div
		};
	});

	let classes = $derived((quire.content.attributes?.class ?? '') + ' chunk scroll-mt-36');
</script>

<div class:active bind:this={div} {...quire.content.attributes} class={classes}>
	{#each quire.content.children as child}
		<Block quire={{ ...quire, content: child, custom }} />
	{/each}
</div>

<style>
	.chunk {
		outline: 1px solid grey;
		padding: 10px 30px;
		margin-top: 60vh;
		background-color: #f0f0f0;
		opacity: 0.5;
		transition: opacity 0.5s;
	}

	.chunk.active {
		opacity: 0.999;
	}
</style>
